alias: Huawei Solar STOP Hold Charging (Day)
description: >-
  Hold and freeze charging and discharging to maintain battery stability.
  Adjusts battery settings based on capacity and limit conditions.
mode: single
sequence:
  - alias: Stop Forcible Charge
    if:
      - condition: template
        value_template: "{{ states('sensor.batteries_forcible_charge') not in ['Stopped'] }}"
    then:
      - data:
          device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
        action: huawei_solar.stop_forcible_charge
  - alias: Charging
    if:
      - condition: template
        value_template: >-
          {{ states('sensor.battery_state_of_capacity') | float(0) <=
          states('predbat.best_charge_limit') | float(0) }}
    then:
      - delay:
          seconds: 10
      - if:
          - condition: template
            value_template: >-
              {% set v = states('number.battery_maximum_charging_power') %} {{ v
              not in ['unknown','unavailable'] and (v | int) != 5000 }}
          - condition: template
            value_template: >-
              {% set battery = states('sensor.battery_state_of_capacity') |
              float(0) %}{% set limit = states('predbat.best_charge_limit') |
              float(0) %}{{ battery < limit }}
        then:
          - target:
              entity_id: number.battery_maximum_charging_power
            data:
              value: "5000"
            action: number.set_value
        else:
          - target:
              entity_id: number.battery_maximum_charging_power
            data:
              value: "0"
            action: number.set_value
    else:
      - delay:
          seconds: 10
      - if:
          - condition: template
            value_template: >-
              {% set v = states('number.battery_maximum_charging_power') %} {{ v
              not in ['unknown','unavailable'] and (v | int) != 0 }}
        then:
          - target:
              entity_id: number.battery_maximum_charging_power
            data:
              value: "0"
            action: number.set_value
  - alias: Discharge 0w
    choose:
      - conditions:
          - condition: template
            value_template: >-
              {% set v = states('number.battery_maximum_discharging_power') %}
              {{ v not in ['unknown','unavailable'] and (v | int) != 0 }}
        sequence:
          - delay:
              seconds: 10
          - target:
              entity_id: number.battery_maximum_discharging_power
            data:
              value: "0"
            action: number.set_value
        alias: "Discharging power 0w if true "
    enabled: true
