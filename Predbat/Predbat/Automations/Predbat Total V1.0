alias: Predbat Charging and Discharging Control
description: >
  This automation manages the charging and discharging of the predbat system
  based on its status and battery level. It adjusts charging times between
  06:00-23:30 and 23:30-06:00, ensuring optimal power management based on
  various conditions and states.
triggers:
  - entity_id: binary_sensor.predbat_exporting
    id: Predbat_export_on
    trigger: state
    to: "on"
    for: "00:00:10"
  - entity_id: binary_sensor.predbat_exporting
    id: Predbat_export_off
    trigger: state
    to: "off"
    for: "00:00:10"
  - entity_id:
      - binary_sensor.predbat_charging
    id: Predbat_charging_on
    trigger: state
    to: "on"
    for:
      hours: 0
      minutes: 0
      seconds: 5
  - trigger: state
    entity_id:
      - predbat.best_charge_limit
    id: charge limit changes
    for:
      hours: 0
      minutes: 0
      seconds: 5
  - entity_id:
      - predbat.status
    id: Status changes
    trigger: state
    for:
      hours: 0
      minutes: 0
      seconds: 5
  - trigger: time_pattern
    minutes: /10
    enabled: false
  - trigger: state
    entity_id: binary_sensor.predbat_car_charging_slot
    for: "00:00:05"
    id: Predbat car charging slot
conditions:
  - condition: state
    entity_id: switch.predbat_set_read_only
    state: "off"
actions:
  - alias: Charge, Export
    choose:
      - conditions:
          - condition: state
            entity_id: binary_sensor.predbat_charging
            state: "on"
          - condition: or
            conditions:
              - condition: state
                entity_id: predbat.status
                state: Charging
              - condition: state
                entity_id: predbat.status
                state: Hold for car
        sequence:
          - alias: 06:00-23:30 Charge
            if:
              - condition: time
                after: "06:00:00"
                before: "23:30:00"
              - condition: numeric_state
                entity_id: sensor.battery_state_of_capacity
                above: 0
                below: 95
              - condition: template
                value_template: |
                  {{ (states('sensor.battery_state_of_capacity')|float(0))
                     < ((states('predbat.best_charge_limit')|float(0)) - 5) }}
                enabled: true
            then:
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.predbat_car_charging_slot
                        state: "on"
                    sequence:
                      - action: script.huawei_charging_power_2500
                      - delay: "00:00:10"
                      - action: script.huawei_discharging_power_0w
                      - condition: template
                        value_template: |
                          {{ (as_timestamp(now()) -
                              as_timestamp(state_attr('automation.predbat_total','last_triggered')|default(0))) > 20 }}
                      - delay: "00:00:10"
                      - action: huawei_solar.forcible_charge_soc
                        data:
                          target_soc: >
                            {% set v =
                            states('predbat.best_charge_limit')|int(0) %} {{ v
                            if v >= 12 else 12 }}
                          power: "2500"
                          device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.predbat_car_charging_slot
                        state: "off"
                    sequence:
                      - action: script.huawei_charging_power_4500w
                        data: {}
                      - delay: "00:00:10"
                      - action: script.huawei_discharging_power_0w
                        data: {}
                      - delay: "00:00:10"
                      - condition: template
                        value_template: |
                          {{ (as_timestamp(now()) -
                              as_timestamp(state_attr('automation.predbat_total','last_triggered')|default(0))) > 20 }}
                      - action: huawei_solar.forcible_charge_soc
                        data:
                          target_soc: >
                            {% set v =
                            states('predbat.best_charge_limit')|int(0) %} {{ v
                            if v >= 12 else 12 }}
                          power: "4500"
                          device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
          - alias: 23:30-06:00 Charge
            if:
              - condition: template
                value_template: >
                  {% set now = now().time() %} {{ now >=
                  strptime('23:30:00','%H:%M:%S').time()
                     or now < strptime('06:00:00','%H:%M:%S').time() }}
              - condition: numeric_state
                entity_id: sensor.battery_state_of_capacity
                above: 0
                below: 95
              - condition: template
                value_template: |
                  {{ (states('sensor.battery_state_of_capacity')|float(0))
                     < ((states('predbat.best_charge_limit')|float(0)) - 5) }}
            then:
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.predbat_car_charging_slot
                        state: "on"
                    sequence:
                      - condition: template
                        value_template: |
                          {{ (as_timestamp(now()) -
                              as_timestamp(state_attr('automation.predbat_total','last_triggered')|default(0))) > 10 }}
                      - action: huawei_solar.forcible_charge_soc
                        data:
                          target_soc: >
                            {% set v =
                            states('predbat.best_charge_limit')|int(0) %} {{ v
                            if v >= 12 else 12 }}
                          power: "2500"
                          device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
                      - delay: "00:00:10"
                      - action: script.huawei_charging_power_2500
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.predbat_car_charging_slot
                        state: "off"
                    sequence:
                      - action: script.huawei_discharging_power_0w
                      - delay: "00:00:10"
                      - action: script.huawei_charging_power_5000w
                      - delay: "00:00:10"
                      - condition: template
                        value_template: |
                          {{ (as_timestamp(now()) -
                              as_timestamp(state_attr('automation.predbat_total','last_triggered')|default(0))) > 20 }}
                      - action: huawei_solar.forcible_charge_soc
                        data:
                          target_soc: >
                            {% set v =
                            states('predbat.best_charge_limit')|int(0) %} {{ v
                            if v >= 12 else 12 }}
                          power: 5000
                          device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
        alias: Charge
      - conditions:
          - condition: trigger
            id:
              - Predbat_export_on
              - Predbat_export_off
          - condition: state
            entity_id: binary_sensor.predbat_charging
            state: "off"
          - condition: state
            entity_id: binary_sensor.predbat_exporting
            state: "on"
        sequence:
          - action: script.huawei_disharging_power_5000w
          - delay: "00:00:10"
          - condition: template
            value_template: |
              {{ states('select.battery_working_mode') != 'fully_fed_to_grid' }}
          - action: select.select_option
            data:
              option: fully_fed_to_grid
            target:
              entity_id: select.battery_working_mode
        alias: Export
  - alias: STOP, Freeze, Hold, Demand
    choose:
      - conditions:
          - condition: or
            conditions:
              - condition: state
                entity_id: predbat.status
                state: Hold for car
              - condition: state
                entity_id: predbat.status
                state: Charging, Hold for car
        sequence:
          - action: script.huawei_discharging_power_0w
        alias: Hold for car. Charging, Hold for car
      - conditions:
          - condition: or
            conditions:
              - condition: state
                entity_id: predbat.status
                state: Hold exporting
              - condition: state
                entity_id: predbat.status
                state: Freeze exporting
        sequence:
          - action: script.huawei_solar_stop_fcfdc_power_0w_export_5000w_import
        alias: Hold exporting
      - conditions:
          - condition: or
            conditions:
              - condition: state
                entity_id: predbat.status
                state: Hold charging
              - condition: state
                entity_id: predbat.status
                state: Freeze charging
        sequence:
          - choose:
              - conditions:
                  - condition: sun
                    before: sunset
                    after: sunrise
                    after_offset: "2"
                    before_offset: "-2"
                sequence:
                  - action: >-
                      script.huawei_solar_stop_fcfdc_power_5000w_export_0w_import
                    data: {}
              - conditions:
                  - condition: sun
                    before: sunrise
                    after: sunset
                    before_offset: "2"
                    after_offset: "-2"
                  - condition: numeric_state
                    entity_id: sensor.inverter_input_power
                    below: 150
                sequence:
                  - action: script.huawei_solar_stop_hold_charging_night
                    data: {}
        alias: Hold Charging
      - conditions:
          - condition: state
            entity_id: predbat.status
            state: Demand
        sequence:
          - action: script.huawei_solar_stop_fcfdc_power_5000w
            data: {}
  - alias: Export off select max self
    if:
      - condition: trigger
        id: Predbat_export_off
      - condition: template
        value_template: >
          {{ states('select.battery_working_mode') !=
          'maximise_self_consumption' }}
    then:
      - action: select.select_option
        data:
          option: maximise_self_consumption
        target:
          entity_id: select.battery_working_mode
  - alias: Car charging on off
    choose:
      - conditions:
          - condition: trigger
            id: Predbat car charging slot
          - condition: state
            entity_id: binary_sensor.predbat_car_charging_slot
            state: "on"
        sequence:
          - action: button.press
            target:
              entity_id: button.go_echarger_265216_frc_3
      - conditions:
          - condition: trigger
            id: Predbat car charging slot
          - condition: state
            entity_id: binary_sensor.predbat_car_charging_slot
            state: "off"
        sequence:
          - action: button.press
            target:
              entity_id: button.go_echarger_265216_frc_2
mode: queued
max: 10
