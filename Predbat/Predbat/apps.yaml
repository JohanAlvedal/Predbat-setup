# ------------------------------------------------------------------
# Predbat - Huawei Solar
# Blueprint for huawei and predbat https://gist.github.com/JohanAlvedal/56e06d6b7b62cf4a080bb04d0e5b015f

# ------------------------------------------------------------------
---
pred_bat:
  module: predbat
  class: PredBat

  # Basic
  prefix: predbat
  timezone: Europe/Stockholm
  threads: auto

  # Currency (main unit + 1/100 part)
  currency_symbols:
    - "Kr"
    - "öre"

  # Filter short 0-load gaps
  load_filter_threshold: 30

  # --- History & forecast ---
  days_previous:
    - 7
    - 14
  days_previous_weight:
    - 1
    - 0.5
  forecast_hours: 24

  # --- Your energy sensors (kWh, daily) ---
  load_today:
    - sensor.load_today
  import_today:
    - sensor.import_today
  export_today:
    - sensor.export_today
  pv_today:
    - sensor.pv_today

  # (optional) battery voltage if you want to log/display it
#   battery_voltage:
#     - sensor.battery_bus_voltage

  # --- Huawei inverter ---
  num_inverters: 1
  inverter_type: "HU"

  # Power/current related (W) – keep your control and measurement sensors
  charge_rate:
    - input_number.predbat_charge
  discharge_rate:
    - input_number.predbat_discharge
  battery_power:
    - sensor.battery_charge_discharge_power
  pv_power:
    - sensor.inverter_input_power
  load_power:
    - sensor.power_meter_active_power
  grid_power:
    - sensor.grid_to_house

  # SOC (percent)
  soc_percent:
    - sensor.battery_state_of_capacity
  soc_max:
    - 10
  charge_limit:
    - number.battery_end_of_charge_soc

  # Reserve and minimum level
  reserve:
    - 15
  battery_min_soc:
    - 15

  # Start/stop – you run via an automation (keep)
  charge_start_service:
    - service: input_boolean.turn_on
      entity_id: input_boolean.charge
  charge_stop_service:
    - service: input_boolean.turn_off
      entity_id: input_boolean.charge
  discharge_start_service:
    - service: input_boolean.turn_on
      entity_id: input_boolean.discharge
  discharge_stop_service:
    - service: input_boolean.turn_off
      entity_id: input_boolean.discharge

  # (ALT) If you switch to direct Huawei services, uncomment the lines below:
  # charge_start_service: huawei_solar/forcible_charge_soc
  # charge_stop_service: huawei_solar/stop_forcible_charge
  # discharge_start_service: huawei_solar/forcible_discharge_soc
  # discharge_stop_service: huawei_solar/stop_forcible_charge

  # Device ID (a string, not a list)
#   device_id: "b0755819f33230378297984b8a08c663"

  # Limits (W)
  inverter_limit:
    - 10000
  battery_rate_max:
    - 5000
  export_limit:
    - 5000

  # (Optional) Charging losses if you have measured values for your battery bank
  battery_charge_power_curve:
    100: 0.16
    99: 0.16
    98: 0.14
    97: 0.61
    96: 0.76
    94: 0.69
    93: 0.41
    92: 0.42
    91: 0.42
    90: 0.42
    89: 0.42
    88: 0.42
    87: 0.31
    86: 0.31
    85: 0.31

  # Clock skew (keep 0 if everything is correct)
  clock_skew: 0

  # Solar forecast (regex matches your Solcast sensors)
  pv_forecast_today: re:(sensor.(solcast_|)(pv_forecast_|)forecast_today)
  pv_forecast_tomorrow: re:(sensor.(solcast_|)(pv_forecast_|)forecast_tomorrow)
  pv_forecast_d3: re:(sensor.(solcast_|)(pv_forecast_|)forecast_(day_3|d3))
  pv_forecast_d4: re:(sensor.(solcast_|)(pv_forecast_|)forecast_(day_4|d4))

  # Car (C40)
  car_charging_energy:
    - sensor.go_echarger_kwh
  num_cars: 1
  car_charging_planned:
    - "re:(binary_sensor\\.go_echarger_265216_car)"
  car_charging_planned_response:
    - "on"
  car_charging_now_response:
    - "yes"
    - "on"
    - "true"
  car_charging_battery_size:
    - 69.45
  car_charging_limit:
    - input_number.predbat_ev_soc
  car_charging_soc:
    - sensor.volvo_c40_battery_charge_level

  # Prices (Nordpool/Tibber)
  metric_octopus_import: sensor.nordpool_tibber
  metric_octopus_export: sensor.nordpool_kwh_ex_vat
  # Tip: ensure that both sensors exist & are updated.
  # Alternatively define rates_import/rates_export manually according to documentation.

  # Notifications
  notify_devices:
    - mobile_app_iphone13pro

  # Scaling (default)
  battery_scaling: 1.0
  import_export_scaling: 1.0

  # Export triggers
  export_triggers:
    - name: "large"
      minutes: 60
      energy: 1.0
    - name: "small"
      minutes: 15
      energy: 0.25
#### ALERT #####################################################################
  # Alert feeds - customise to your country and the alert types, severity and keep value
  # customise to your needs, delete the ones you don't want to trigger on - e.g. remove Amber, Moderate and Possible.
  alerts:
    url: "https://feeds.meteoalarm.org/feeds/meteoalarm-legacy-atom-sweden"
    event: "(Amber|Yellow|Orange|Red).*(Wind|Snow|Fog|Rain|Thunderstorm|Frost|Heat|Flood|Forestfire|Ice|Low temperature|Storm|Tornado|Volcano|Wildfire)"
    severity: "Moderate|Severe|Extreme"
    certainty: "Possible|Likely|Expected"
    keep: 40
# # ---------------------------
# # Predheat
# # ---------------------------
# predheat:
#   forecast_days: 2
#   days_previous:
#     - 7
#   mode: pump
#   external_temperature: sensor.temperatur_nu
#   internal_temperature:
#     - sensor.temp_hall_nere_temperature
#   weather: weather.openweathermap
#   target_temperature: input_number.indoor_target_temperature
#   smart_thermostat: false
#   heating_energy: sensor.daily_heat_in_kwh
#   heating_energy_scaling: 1.0
#   heating_active: sensor.heating_status
#   heat_loss_watts: 120
#   heat_gain_static: 200
#   heat_loss_degrees: 0.030
#   heat_output: 5000
#   heat_volume: 75
#   heat_max_power: 6000
#   heat_min_power: 60
#   heat_cop: 4.0
#   flow_temp: sensor.hp_radiator_forward
#   flow_difference_target: 10
#   heat_pump_efficiency:
#     -20: 2.10
#     -18: 2.15
#     -16: 2.2
#     -14: 2.25
#     -12: 2.3
#     -10: 2.4
#     -8: 2.5
#     -6: 2.6
#     -4: 2.7
#     -2: 2.8
#     0: 2.9
#     2: 3.1
#     4: 3.3
#     6: 3.6
#     8: 3.8
#     10: 3.9
#     12: 4.1
#     14: 4.3
#     16: 4.3
#     18: 4.3
#     20: 4.3
